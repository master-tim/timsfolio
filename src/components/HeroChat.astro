---
---

<!-- Regular Chat Widget -->
<div class="relative w-full mx-auto max-w-5xl mt-6 md:mt-2 reveal-on-scroll group">
  <div class="text-center mb-3 font-mono text-xs tracking-[0.2em] uppercase text-pblack/70">Chat with my AI portfolio</div>
  <!-- Chat Container -->
  <div id="chat-widget" class="bg-white border-3 border-black shadow-[10px_10px_0px_0px_rgba(0,0,0,1)] p-6 rounded-2xl relative z-10 transition-all duration-300 hover:shadow-[14px_14px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-1.5">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-4 border-b-2 border-black pb-3">
      <button id="btn-reset" class="w-3 h-3 rounded-full bg-red-500 border border-black hover:scale-110 transition-transform cursor-pointer" aria-label="Reset Chat"></button>
      <button id="btn-disable" class="w-3 h-3 rounded-full bg-yellow-500 border border-black hover:scale-110 transition-transform cursor-pointer" aria-label="Disable Input"></button>
      <span class="w-3 h-3 rounded-full bg-green-500 border border-black" aria-hidden="true"></span>
      <div class="flex-1 text-center text-sm md:text-base font-black text-pblack leading-tight">
        Hey, I'm Temirlan — ask me anything about my AI + 3D web work
      </div>
      <div class="ml-auto flex items-center gap-2 font-mono text-xs">
        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
        <span class="font-bold text-pblack/70">AI_ONLINE</span>
      </div>
    </div>

    <!-- Chat History / Output -->
    <div id="chat-output" class="min-h-[280px] max-h-[520px] overflow-y-auto mb-4 font-mono text-sm space-y-3 bg-gray-50 p-4 border-2 border-black rounded-lg shadow-inner">
      <div class="text-pblack/70 hidden sm:block">
        > Ask me anything about Tim's experience, skills, or projects.
      </div>
    </div>

    <!-- Input Area -->
    <form id="chat-form" class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center justify-center max-w-2xl mx-auto">
      <input 
        type="text" 
        id="chat-input" 
        placeholder="e.g., Does Tim know React?" 
        class="flex-1 bg-white border-2 border-black px-3 py-2 text-sm focus:outline-none focus:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] transition-all font-mono w-full"
        required
      />
      <button 
        type="submit" 
        class="bg-pblue text-white border-2 border-black px-4 py-2 text-sm font-bold hover:translate-y-[-2px] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-y-[0px] active:shadow-none transition-all font-mono w-full sm:w-auto"
      >
        ASK
      </button>
    </form>

    <!-- Suggestions -->
    <div class="flex gap-2 mt-3 overflow-x-auto pb-1 no-scrollbar">
      <button type="button" class="suggestion-btn text-xs bg-gray-100 px-2 py-1 rounded border border-black hover:bg-gray-200 transition whitespace-nowrap font-mono">Tell me about Temirlan's skills</button>
      <button type="button" class="suggestion-btn text-xs bg-gray-100 px-2 py-1 rounded border border-black hover:bg-gray-200 transition whitespace-nowrap font-mono">What is his experience with AI?</button>
    </div>
    
    <div class="mt-2 text-[10px] text-gray-400 text-center font-mono">
      * AI can make mistakes. Please verify important info.
    </div>
  </div>

  <!-- Decorative Background Element -->
  <div class="absolute -top-4 -right-4 w-full h-full bg-ppink border-2 border-black rounded-lg -z-10"></div>
</div>

<script>
  import { marked } from 'marked';

  class ChatUI {
    constructor(outputs) {
      this.outputs = outputs;
      this.typingId = 'typing-indicator';
    }

    scrollToBottom() {
      this.outputs.forEach(el => (el.scrollTop = el.scrollHeight));
    }

    addMessage(role, text, className, isMarkdown = false) {
      this.outputs.forEach(outputEl => {
        const div = document.createElement('div');
        div.className = 'break-words ' + className + ' message-entry';
        div.innerHTML = '<span class="opacity-50 text-xs uppercase mr-1">[' + role + ']</span> ';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'inline-block align-top markdown-content';

        if (isMarkdown) {
          contentDiv.innerHTML = marked.parse(text);
        } else {
          contentDiv.textContent = text;
        }

        div.appendChild(contentDiv);
        outputEl.appendChild(div);
      });
      this.scrollToBottom();
    }

    showTyping() {
      this.hideTyping();

      this.outputs.forEach(outputEl => {
        const div = document.createElement('div');
        div.id = this.typingId;
        div.className = 'flex items-center gap-1 py-2 text-gray-400';
        div.innerHTML = `
          <span class="text-xs font-mono mr-2">> Thinking</span>
          <div class="typing-dot bg-gray-400"></div>
          <div class="typing-dot bg-gray-400"></div>
          <div class="typing-dot bg-gray-400"></div>
        `;
        outputEl.appendChild(div);
      });
      this.scrollToBottom();
    }

    hideTyping() {
      this.outputs.forEach(outputEl => {
        const el = outputEl.querySelector('#' + this.typingId);
        if (el) el.remove();
      });
    }

    createAIResponseContainer() {
      const containerIds = [];
      this.outputs.forEach(outputEl => {
        const div = document.createElement('div');
        div.className = 'break-words text-pblack message-entry';
        div.innerHTML = '<span class="opacity-50 text-xs uppercase mr-1">[AI]</span> ';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'inline-block align-top markdown-content';
        div.appendChild(contentDiv);
        outputEl.appendChild(div);

        containerIds.push(contentDiv);
      });
      this.scrollToBottom();
      return containerIds;
    }

    updateStream(containers, fullText, isCached = false) {
      const html = marked.parse(fullText);
      containers.forEach(container => {
        container.innerHTML = html;
        if (isCached) {
          const parent = container.parentElement;
          const label = parent.querySelector('span');
          if (label && !label.innerHTML.includes('⚡')) {
            label.innerHTML = '[AI] <span class="text-pgreen" title="Response served from cache">⚡</span> ';
          }
        }
      });
      this.scrollToBottom();
    }

    clear() {
      this.outputs.forEach(outputEl => {
        outputEl.innerHTML = `
          <div class="text-pblack/70 hidden sm:block">
            > Ask me anything about Tim's experience, skills, or projects.
          </div>
        `;
      });
    }

    syncFrom(sourceOutput) {
      const html = sourceOutput.innerHTML;
      this.outputs.forEach(out => {
        if (out !== sourceOutput) {
          out.innerHTML = html;
        }
      });
    }
  }

  function initChat() {
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');
    const output = document.getElementById('chat-output');
    const suggestionBtns = document.querySelectorAll('.suggestion-btn');
    const btnReset = document.getElementById('btn-reset');
    const btnDisable = document.getElementById('btn-disable');

    let chatHistory = [];

    if (!form || !input || !output) return;

    const chatUI = new ChatUI([output]);

    const handleSuggestion = (btn) => {
      btn.addEventListener('click', () => {
        input.value = btn.textContent || '';
        input.focus();
      });
    };
    suggestionBtns.forEach(handleSuggestion);

    if (btnReset) {
      btnReset.addEventListener('click', () => {
        chatUI.clear();
        input.value = '';
        input.disabled = false;
        input.placeholder = "e.g., Does Tim know React?";
        input.classList.remove('bg-gray-100', 'cursor-not-allowed');
        chatHistory = [];
        input.focus();
      });
    }

    if (btnDisable) {
      btnDisable.addEventListener('click', () => {
        const isDisabled = !input.disabled;
        input.disabled = isDisabled;
        if (isDisabled) {
          input.placeholder = "Input disabled...";
          input.classList.add('bg-gray-100', 'cursor-not-allowed');
        } else {
          input.placeholder = "e.g., Does Tim know React?";
          input.classList.remove('bg-gray-100', 'cursor-not-allowed');
          input.focus();
        }
      });
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const message = input.value.trim();
      if (!message) return;

      if (message.split(/\s+/).length > 50) {
        chatUI.addMessage('System', 'Question is too long. Please limit to 50 words.', 'text-red-600 font-bold');
        input.value = '';
        return;
      }

      input.value = '';
      input.disabled = true;

      chatUI.addMessage('User', message, 'text-pblue font-bold');
      chatUI.showTyping();

      chatHistory.push({ role: 'user', content: message });

      try {
        const res = await fetch('/api/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: message, history: chatHistory }),
        });

        chatUI.hideTyping();

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || res.statusText);
        }

        const containers = chatUI.createAIResponseContainer();

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';
        let isCached = false;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') break;

              try {
                const parsed = JSON.parse(data);
                if (parsed.cached === true) isCached = true;
                if (parsed.error) throw new Error(parsed.error);
                if (parsed.chunk) {
                  fullText += parsed.chunk;
                  chatUI.updateStream(containers, fullText, isCached);
                }
              } catch (e) {
                console.error('Error parsing stream:', e);
              }
            }
          }
        }

        chatHistory.push({ role: 'assistant', content: fullText });
      } catch (err) {
        chatUI.hideTyping();
        chatHistory.pop();
        chatUI.addMessage('System', `Error: ${err.message}`, 'text-red-600 font-bold');
      } finally {
        input.disabled = false;
        input.focus();
      }
    }

    form.addEventListener('submit', handleSubmit);
  }

  document.addEventListener('astro:page-load', initChat);
</script>

<style is:global>
  /* Hide scrollbar */
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

  /* Markdown Styles */
  .markdown-content p { margin-bottom: 0.5rem; }
  .markdown-content p:last-child { margin-bottom: 0; }
  .markdown-content ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; }
  .markdown-content ol { list-style-type: decimal; padding-left: 1.2rem; margin-bottom: 0.5rem; }
  .markdown-content li { margin-bottom: 0.2rem; }
  .markdown-content strong { font-weight: bold; }
  .markdown-content em { font-style: italic; }
  .markdown-content code { background-color: #f3f4f6; padding: 0.1rem 0.3rem; border-radius: 0.2rem; font-family: monospace; font-size: 0.9em; }

  /* Typing Animation */
  .typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin: 0 2px;
    animation: typing 1.4s infinite ease-in-out both;
  }
  .typing-dot:nth-child(1) { animation-delay: -0.32s; }
  .typing-dot:nth-child(2) { animation-delay: -0.16s; }
  
  @keyframes typing {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }

  /* Message Entry Animation */
  .message-entry {
    animation: fadeIn 0.3s ease-out forwards;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
