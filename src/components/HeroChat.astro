---
---

<!-- Chat Widget Container -->
<div class="relative w-full mx-auto max-w-4xl mt-8 md:mt-4 group font-sans">
  
  <!-- Decorative Shadow Element -->
  <div class="absolute -inset-0.5 bg-black rounded-2xl translate-x-2 translate-y-2 z-0"></div>
  
  <!-- Main Card -->
  <div id="chat-widget" class="relative z-10 bg-white border-2 border-black rounded-2xl overflow-hidden flex flex-col h-[500px] md:h-[600px] transition-transform duration-300">
    
    <!-- Header -->
    <div class="bg-gray-50 border-b-2 border-black p-4 flex items-center justify-between select-none">
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full bg-ppink border border-black"></div>
        <div class="w-3 h-3 rounded-full bg-pyellow border border-black"></div>
        <div class="w-3 h-3 rounded-full bg-pgreen border border-black"></div>
      </div>
      <div class="font-bold text-xs md:text-sm tracking-widest text-pblack uppercase flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-pgreen animate-pulse"></span>
        AI_PORTFOLIO_ASSISTANT
      </div>
      <button id="btn-reset" class="text-xs font-bold text-pblack hover:text-black hover:underline uppercase tracking-wider cursor-pointer">
        Reset
      </button>
    </div>

    <!-- Chat History -->
    <div id="chat-output" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth bg-[#fafafa]">
      <!-- Welcome Message -->
      <div class="flex gap-4 message-entry">
        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-pblack flex items-center justify-center text-white shrink-0 border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
          <span class="font-kablamo text-xs md:text-sm">AI</span>
        </div>
        <div class="space-y-2 max-w-[85%]">
          <div class="bg-white border-2 border-black rounded-xl rounded-tl-none p-4 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]">
            <p class="text-pblack font-medium text-sm md:text-base">Hello! I'm Tim's AI assistant.</p>
            <p class="text-pblack/80 text-sm mt-2">I can tell you about his projects, skills, and experience. Try asking:</p>
            <div class="flex flex-wrap gap-2 mt-3">
              <button class="suggestion-btn text-xs bg-pblue/10 hover:bg-pblue/30 border border-black px-3 py-1.5 rounded-lg transition-all hover:-translate-y-0.5 hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] font-bold text-pblack cursor-pointer">
                What are Tim's main skills?
              </button>
              <button class="suggestion-btn text-xs bg-pgreen/10 hover:bg-pgreen/30 border border-black px-3 py-1.5 rounded-lg transition-all hover:-translate-y-0.5 hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] font-bold text-pblack cursor-pointer">
                Show me his latest projects
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="p-4 bg-white border-t-2 border-black">
      <form id="chat-form" class="relative flex items-center gap-2">
        <input 
          type="text" 
          id="chat-input" 
          placeholder="Ask me anything about Tim..." 
          class="w-full bg-gray-50 border-2 border-black rounded-xl px-4 py-3 md:py-4 text-sm md:text-base text-pblack placeholder:text-gray-400 focus:outline-none focus:ring-0 focus:bg-white focus:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all font-medium"
          required
          autocomplete="off"
        />
        <button 
          type="submit" 
          class="absolute right-2 top-1/2 -translate-y-1/2 bg-pblack text-white p-2 md:p-2.5 rounded-lg border-2 border-black hover:bg-black hover:scale-105 active:scale-95 transition-all cursor-pointer"
          aria-label="Send message"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
      </form>
      <div class="text-center mt-3 flex justify-center gap-4">
         <p class="text-[10px] text-gray-400 uppercase tracking-wider font-bold">Powered by AI â€¢ May make mistakes</p>
      </div>
    </div>

  </div>
</div>

<script>
  import { marked } from 'marked';

  // Configure marked to render links properly
  marked.setOptions({
    breaks: true,
    gfm: true,
  });

  // Custom renderer for links - marked v17 uses token objects
  const renderer = new marked.Renderer();
  const originalLinkRenderer = renderer.link.bind(renderer);
  renderer.link = function(token) {
    // In marked v17+, the link function receives a token object
    const href = token.href || token;
    const title = token.title || '';
    const text = token.text || token.tokens?.[0]?.text || '';
    
    return `<a href="${href}" ${title ? `title="${title}"` : ''}>${text}</a>`;
  };
  marked.use({ renderer });

  class ChatUI {
    constructor(output, widget) {
      this.output = output;
      this.widget = widget;
      this.typingId = 'typing-indicator';
    }

    scrollToBottom() {
      this.output.scrollTop = this.output.scrollHeight;
    }

    addMessage(role, text, isMarkdown = false) {
      const isUser = role.toLowerCase() === 'user';
      
      const div = document.createElement('div');
      div.className = `flex gap-4 message-entry ${isUser ? 'flex-row-reverse' : ''}`;
      
      // Avatar
      const avatar = document.createElement('div');
      avatar.className = `w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center shrink-0 border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] ${isUser ? 'bg-ppink text-black' : 'bg-pblack text-white'}`;
      avatar.innerHTML = `<span class="font-kablamo text-xs md:text-sm">${isUser ? 'ME' : 'AI'}</span>`;
      
      // Content Bubble
      const bubbleWrapper = document.createElement('div');
      bubbleWrapper.className = `space-y-2 max-w-[85%] ${isUser ? 'flex justify-end' : ''}`;
      
      const bubble = document.createElement('div');
      bubble.className = `border-2 border-black rounded-xl p-4 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)] text-sm md:text-base ${
        isUser 
          ? 'bg-pblue/20 rounded-tr-none text-pblack font-medium' 
          : 'bg-white rounded-tl-none text-pblack'
      }`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'markdown-content break-words';

      if (isMarkdown) {
        contentDiv.innerHTML = marked.parse(text);
      } else {
        contentDiv.textContent = text;
      }

      bubble.appendChild(contentDiv);
      bubbleWrapper.appendChild(bubble);
      
      div.appendChild(avatar);
      div.appendChild(bubbleWrapper);
      
      this.output.appendChild(div);
      this.scrollToBottom();
      
      return contentDiv; // Return content div for streaming updates
    }

    showTyping() {
      this.hideTyping();
      
      const div = document.createElement('div');
      div.id = this.typingId;
      div.className = 'flex gap-4 message-entry';
      
      div.innerHTML = `
        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-pblack flex items-center justify-center text-white shrink-0 border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
          <span class="font-kablamo text-xs md:text-sm">AI</span>
        </div>
        <div class="space-y-2 max-w-[85%]">
          <div class="bg-white border-2 border-black rounded-xl rounded-tl-none p-4 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)] flex items-center gap-1">
            <div class="typing-dot bg-pblack"></div>
            <div class="typing-dot bg-pblack"></div>
            <div class="typing-dot bg-pblack"></div>
          </div>
        </div>
      `;
      
      this.output.appendChild(div);
      this.scrollToBottom();
    }

    hideTyping() {
      const el = this.output.querySelector('#' + this.typingId);
      if (el) el.remove();
    }

    clear() {
      // Keep only the first welcome message
      const welcome = this.output.firstElementChild;
      this.output.innerHTML = '';
      if (welcome) this.output.appendChild(welcome);
    }
  }

  function initChat() {
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');
    const output = document.getElementById('chat-output');
    const suggestionBtns = document.querySelectorAll('.suggestion-btn');
    const btnReset = document.getElementById('btn-reset');
    const chatWidget = document.getElementById('chat-widget');

    if (!form || !input || !output || !chatWidget) return;

    let chatHistory = [];
    const chatUI = new ChatUI(output, chatWidget);

    // Handle Suggestions
    suggestionBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const text = btn.textContent.trim();
        input.value = text;
        handleSubmit(new Event('submit'));
      });
    });

    // Handle Reset
    if (btnReset) {
      btnReset.addEventListener('click', () => {
        chatUI.clear();
        input.value = '';
        input.disabled = false;
        chatHistory = [];
        input.focus();
      });
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const message = input.value.trim();
      if (!message) return;

      if (message.split(/\s+/).length > 50) {
        alert('Question is too long. Please limit to 50 words.');
        return;
      }

      input.value = '';
      input.disabled = true;

      // Add User Message
      chatUI.addMessage('User', message);
      chatUI.showTyping();

      chatHistory.push({ role: 'user', content: message });

      try {
        const res = await fetch('/api/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: message, history: chatHistory }),
        });

        chatUI.hideTyping();

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || res.statusText);
        }

        // Create AI Response Container
        const contentDiv = chatUI.addMessage('AI', '', true);
        
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') break;

              try {
                const parsed = JSON.parse(data);
                if (parsed.chunk) {
                  fullText += parsed.chunk;
                  const parsedHTML = marked.parse(fullText);
                  console.log('Raw text:', fullText.substring(fullText.length - 100)); // Last 100 chars
                  console.log('Parsed HTML:', parsedHTML.substring(parsedHTML.length - 200)); // Last 200 chars
                  contentDiv.innerHTML = parsedHTML;
                  chatUI.scrollToBottom();
                }
              } catch (e) {
                console.error('Error parsing stream:', e);
              }
            }
          }
        }

        chatHistory.push({ role: 'assistant', content: fullText });
      } catch (err) {
        chatUI.hideTyping();
        chatUI.addMessage('AI', `Sorry, I encountered an error: ${err.message}`);
      } finally {
        input.disabled = false;
        input.focus();
      }
    }

    form.addEventListener('submit', handleSubmit);
  }

  document.addEventListener('astro:page-load', initChat);
</script>

<style is:global>
  /* Markdown Styles */
  .markdown-content p { margin-bottom: 0.5rem; }
  .markdown-content p:last-child { margin-bottom: 0; }
  .markdown-content ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; }
  .markdown-content ol { list-style-type: decimal; padding-left: 1.2rem; margin-bottom: 0.5rem; }
  .markdown-content li { margin-bottom: 0.2rem; }
  .markdown-content strong { font-weight: 700; color: #4E6273; }
  .markdown-content em { font-style: italic; }
  .markdown-content code { background-color: #f3f4f6; padding: 0.1rem 0.3rem; border-radius: 0.2rem; font-family: monospace; font-size: 0.9em; color: #d63384; }
  .markdown-content pre { background-color: #1e1e1e; color: #f8f8f2; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 0.5rem; }
  
  /* Enhanced Link Styles - Highly Highlighted */
  .markdown-content a {
    color: #1d4ed8;
    text-decoration: none;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.875rem;
    border-radius: 0.5rem;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border: 2px solid #3b82f6;
    transition: all 0.25s ease;
    margin: 0.25rem 0.125rem;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25), 0 0 0 0 rgba(59, 130, 246, 0.4);
    position: relative;
    overflow: hidden;
  }
  
  .markdown-content a::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s ease;
  }
  
  .markdown-content a:hover::before {
    left: 100%;
  }
  
  .markdown-content a:hover {
    background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
    border-color: #2563eb;
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4), 0 0 0 3px rgba(59, 130, 246, 0.2);
  }
  
  .markdown-content a:active {
    transform: translateY(0) scale(1);
    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
  }

  /* Typing Animation */
  .typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin: 0 2px;
    animation: typing 1.4s infinite ease-in-out both;
  }
  .typing-dot:nth-child(1) { animation-delay: -0.32s; }
  .typing-dot:nth-child(2) { animation-delay: -0.16s; }
  
  @keyframes typing {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }

  /* Message Entry Animation */
  .message-entry {
    animation: fadeIn 0.3s ease-out forwards;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
